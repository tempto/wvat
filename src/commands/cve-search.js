const Command = require("../BaseCommand");
const { searchCVEsInLocalCache, parseLocalCacheCVEEntries } = require("../CVEListFetcher");
const { buildRegexFromSearchQuery } = require("../utils");

class CveSearchCommand extends Command {
    run() {
        const { args } = this.parse(CveSearchCommand);

        const search_query_regex = buildRegexFromSearchQuery(args.search_query);

        this.log("Starting Search ...");

        searchCVEsInLocalCache(search_query_regex, (err, results) => {
            if (err) throw new Error("Failed to search CVEs in local file");

            const lines = results.map((entry) => entry.line);
            this.log(`Number of CVE found: ${lines.length}\n`);

            this.log(parseLocalCacheCVEEntries(lines));
        });
    }
}

CveSearchCommand.description = "(TEMPORARY COMMAND) Search for CVEs in the local CVE file";

CveSearchCommand.args = [
    {
        name: "search_query",
        required: true,
        description: "Search query to search for CVEs",
        hidden: false,
    },
];

module.exports = CveSearchCommand;
